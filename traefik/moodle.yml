#
# Traefik File Provider - Moodle Route
#
# KEIN stripPrefix! Moodle braucht den vollen Pfad für korrekte URL-Generierung.
# Traefik übernimmt nur den Trailing-Slash-Redirect (HTTPS statt Apaches HTTP).
#
# Anpassung: PathPrefix und redirectRegex an den gewünschten Pfad anpassen.
#

http:
  routers:
    # Redirect: /learningmanagement1 → /learningmanagement1/ (mit HTTPS)
    moodle-trailing-slash:
      rule: "Path(`/learningmanagement1`)"
      service: moodle-app
      entryPoints:
        - websecure
      tls: {}
      middlewares:
        - moodle-add-slash
      priority: 100

    # Alle Requests unter /learningmanagement1/ → Moodle
    moodle-app:
      rule: "PathPrefix(`/learningmanagement1/`)"
      service: moodle-app
      entryPoints:
        - websecure
      tls: {}
      middlewares:
        - moodle-headers

  middlewares:
    moodle-add-slash:
      redirectRegex:
        regex: "^(https?://[^/]+)/learningmanagement1$"
        replacement: "${1}/learningmanagement1/"
        permanent: true

    moodle-headers:
      headers:
        customRequestHeaders:
          X-Forwarded-Proto: https
        frameDeny: false
        customResponseHeaders:
          X-Frame-Options: ALLOWALL

  services:
    moodle-app:
      loadBalancer:
        servers:
          - url: "http://edulution-moodle-app:80"
