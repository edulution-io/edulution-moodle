# =====================================================
# EDULUTION MOODLE - TRAEFIK STATIC CONFIGURATION
# =====================================================
# Standalone Traefik-Konfiguration
# Wird verwendet wenn Moodle ohne edulution-Infrastruktur laeuft
#
# Verwendung:
#   docker compose --profile ssl up -d
# =====================================================

# ===========================================
# GLOBAL SETTINGS
# ===========================================
global:
  checkNewVersion: false
  sendAnonymousUsage: false

# ===========================================
# API / DASHBOARD
# ===========================================
api:
  dashboard: false
  insecure: false

# ===========================================
# LOG
# ===========================================
log:
  level: WARN
  format: json

accessLog:
  format: json
  filters:
    statusCodes:
      - "400-599"
  fields:
    defaultMode: keep
    names:
      ClientUsername: drop
    headers:
      defaultMode: keep
      names:
        Authorization: drop
        Cookie: drop
        Set-Cookie: drop

# ===========================================
# ENTRYPOINTS
# ===========================================
entryPoints:
  # HTTP (Port 80) - Redirect zu HTTPS
  web:
    address: ":80"
    http:
      redirections:
        entryPoint:
          to: websecure
          scheme: https
          permanent: true

  # HTTPS (Port 443)
  websecure:
    address: ":443"
    http:
      tls:
        certResolver: letsencrypt
    # Timeouts fuer grosse Uploads
    transport:
      respondingTimeouts:
        readTimeout: 300s
        writeTimeout: 300s
        idleTimeout: 180s

# ===========================================
# CERTIFICATE RESOLVERS (Let's Encrypt)
# ===========================================
certificatesResolvers:
  letsencrypt:
    acme:
      # E-Mail fuer Let's Encrypt Benachrichtigungen
      email: "${ACME_EMAIL}"
      # Speicherort fuer Zertifikate
      storage: /letsencrypt/acme.json
      # HTTP Challenge (Port 80 muss erreichbar sein)
      httpChallenge:
        entryPoint: web
      # Optional: DNS Challenge fuer Wildcard-Zertifikate
      # dnsChallenge:
      #   provider: cloudflare
      #   delayBeforeCheck: 0
      #   resolvers:
      #     - "1.1.1.1:53"
      #     - "8.8.8.8:53"

# ===========================================
# PROVIDERS
# ===========================================
providers:
  # Docker Provider (fuer Labels)
  docker:
    endpoint: "unix:///var/run/docker.sock"
    exposedByDefault: false
    network: moodle-net
    watch: true

  # File Provider (dynamische Konfiguration)
  file:
    directory: /etc/traefik/dynamic
    watch: true

# ===========================================
# HEALTH CHECK
# ===========================================
ping:
  entryPoint: websecure

# ===========================================
# METRICS (optional)
# ===========================================
# metrics:
#   prometheus:
#     entryPoint: websecure
#     addEntryPointsLabels: true
#     addServicesLabels: true
