services:
  edulution-moodle:
    image: ghcr.io/edulution-io/edulution-moodle:dev
    restart: always
    container_name: edulution-moodle
    volumes:
      - /srv/docker/edulution-ui/data/apps/moodle:/srv/docker/edulution-moodle
      - /srv/docker/edulution-ui/data/apps/moodle/secrets:/run/secrets:ro
    env_file:
      - /srv/docker/edulution-ui/edulution.env
    environment:
      - MOODLE_HOSTNAME=${EDULUTION_BASE_DOMAIN}
      - MOODLE_PATH=/srv/docker/edulution-moodle
      - KEYCLOAK_SECRET_KEY=${KEYCLOAK_EDU_MAILCOW_SYNC_SECRET}
      # Database
      - MOODLE_DATABASE_HOST=edulution-moodle-db
      - MOODLE_DATABASE_NAME=moodle
      - MOODLE_DATABASE_USER=moodle
      - MOODLE_DATABASE_PASSWORD_FILE=/run/secrets/db_password
      # Redis
      - REDIS_HOST=edulution-moodle-redis
      - REDIS_PORT=6379
    depends_on:
      edulution-moodle-db:
        condition: service_healthy
      edulution-moodle-redis:
        condition: service_healthy
    networks:
      - edulution-ui_default

  edulution-moodle-db:
    image: mariadb:10.11
    restart: always
    container_name: edulution-moodle-db
    volumes:
      - /srv/docker/edulution-ui/data/apps/moodle/mariadb:/var/lib/mysql
      - /srv/docker/edulution-ui/data/apps/moodle/secrets:/run/secrets:ro
    environment:
      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/db_root_password
      MYSQL_DATABASE: moodle
      MYSQL_USER: moodle
      MYSQL_PASSWORD_FILE: /run/secrets/db_password
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - edulution-ui_default

  edulution-moodle-redis:
    image: redis:7-alpine
    restart: always
    container_name: edulution-moodle-redis
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - /srv/docker/edulution-ui/data/apps/moodle/redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - edulution-ui_default

networks:
  edulution-ui_default:
    external: true
