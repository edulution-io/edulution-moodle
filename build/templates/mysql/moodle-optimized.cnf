# =============================================================================
# MARIADB CONFIGURATION FOR MOODLE
# edulution-moodle - Optimized Database Settings
# =============================================================================
# This file should be placed in /etc/mysql/conf.d/ or mounted as a volume
# Optimized for Moodle workloads with 2-4GB RAM allocated to MariaDB
# =============================================================================

[client]
# Default character set for client connections
default-character-set = utf8mb4

[mysql]
# Default character set for mysql CLI
default-character-set = utf8mb4

[mysqld]
# =============================================================================
# CHARACTER SET & COLLATION
# =============================================================================
# Moodle requires utf8mb4 for full Unicode support (including emojis)
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci
character-set-client-handshake = FALSE
init_connect = 'SET NAMES utf8mb4 COLLATE utf8mb4_unicode_ci'

# =============================================================================
# INNODB SETTINGS
# =============================================================================
# InnoDB is the recommended storage engine for Moodle

# Buffer pool: Main memory area for caching data and indexes
# Recommended: 50-70% of available RAM on dedicated DB server
# Adjust based on your server's memory (default: 1GB)
innodb_buffer_pool_size = 1G

# Number of buffer pool instances (1 per GB of buffer pool size)
innodb_buffer_pool_instances = 4

# Log file size: Larger = better write performance, longer recovery
innodb_log_file_size = 256M

# Log buffer: Memory for transaction logs before writing to disk
innodb_log_buffer_size = 64M

# Flush method: O_DIRECT bypasses OS cache (reduces double buffering)
innodb_flush_method = O_DIRECT

# When to flush logs: 2 = flush every second (good performance, slight risk)
# Use 1 for full ACID compliance (slower)
innodb_flush_log_at_trx_commit = 2

# Each table in its own file (easier management, better compression)
innodb_file_per_table = 1

# I/O capacity: Increase for SSDs (default: 200, SSD: 2000-10000)
innodb_io_capacity = 2000
innodb_io_capacity_max = 4000

# Read/Write I/O threads (increase for SSD)
innodb_read_io_threads = 8
innodb_write_io_threads = 8

# Doublewrite buffer (disable only on ZFS or battery-backed RAID)
innodb_doublewrite = 1

# Adaptive hash index (usually beneficial, but can cause contention)
innodb_adaptive_hash_index = ON

# Change buffer: buffer INSERT, UPDATE, DELETE on secondary indexes
innodb_change_buffer_max_size = 25

# Lock wait timeout (in seconds)
innodb_lock_wait_timeout = 120

# Print deadlock info to error log
innodb_print_all_deadlocks = ON

# =============================================================================
# QUERY CACHE (MariaDB specific, deprecated in MySQL 8.0)
# =============================================================================
# Can help with repetitive read queries common in Moodle
query_cache_type = 1
query_cache_size = 64M
query_cache_limit = 2M
query_cache_min_res_unit = 2K

# =============================================================================
# CONNECTION SETTINGS
# =============================================================================
# Maximum simultaneous connections
max_connections = 200

# Maximum packet size (for large imports/exports)
max_allowed_packet = 64M

# Thread cache to reduce thread creation overhead
thread_cache_size = 50

# Connection timeout
wait_timeout = 600
interactive_timeout = 600

# =============================================================================
# TEMPORARY TABLES
# =============================================================================
# In-memory temp tables (per-connection)
tmp_table_size = 64M
max_heap_table_size = 64M

# Temporary directory
tmpdir = /tmp

# =============================================================================
# TABLE & OPEN FILE SETTINGS
# =============================================================================
# Table cache (Moodle has many tables)
table_open_cache = 4000
table_definition_cache = 2000

# Open files limit
open_files_limit = 65535

# =============================================================================
# SORT & JOIN BUFFERS
# =============================================================================
# Per-connection buffers (don't set too high)
sort_buffer_size = 4M
join_buffer_size = 4M
read_buffer_size = 2M
read_rnd_buffer_size = 2M

# =============================================================================
# LOGGING
# =============================================================================
# Enable slow query log for performance tuning
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2
log_queries_not_using_indexes = 1

# General query log (disable in production, enable for debugging)
general_log = 0
general_log_file = /var/log/mysql/general.log

# Error log
log_error = /var/log/mysql/error.log
log_warnings = 2

# Binary log (required for replication, point-in-time recovery)
# Uncomment if you need replication or want binary log backups
# log_bin = /var/log/mysql/mysql-bin
# binlog_format = ROW
# expire_logs_days = 7
# max_binlog_size = 100M
# sync_binlog = 1

# =============================================================================
# PERFORMANCE SCHEMA
# =============================================================================
# Enable for monitoring (slight overhead, but useful for tuning)
performance_schema = ON
performance_schema_max_table_instances = 500

# =============================================================================
# SECURITY
# =============================================================================
# Disable symbolic links (security best practice)
symbolic-links = 0

# Disable local file loading (unless specifically needed)
local_infile = 0

# Secure file privilege location
# secure_file_priv = /var/lib/mysql-files

# =============================================================================
# REPLICATION SETTINGS (if using replication)
# =============================================================================
# Unique server ID (change for each server in a replication setup)
# server-id = 1

# =============================================================================
# ADDITIONAL OPTIMIZATIONS
# =============================================================================
# Skip name resolution (faster connections, use IPs in grants)
skip-name-resolve = 1

# Skip external locking
skip-external-locking = 1

# Disable DNS hostname lookups
skip-host-cache = 1

# Key buffer for MyISAM (Moodle uses InnoDB, but some temp tables use MyISAM)
key_buffer_size = 32M

# Bulk insert buffer (for large INSERT operations)
bulk_insert_buffer_size = 64M

# =============================================================================
# GALERA CLUSTER SETTINGS (if using MariaDB Galera)
# =============================================================================
# Uncomment and configure for Galera cluster setup
# [galera]
# wsrep_on = ON
# wsrep_provider = /usr/lib/galera/libgalera_smm.so
# wsrep_cluster_address = "gcomm://node1,node2,node3"
# wsrep_cluster_name = "moodle_cluster"
# wsrep_node_address = "this_node_ip"
# wsrep_node_name = "this_node_name"
# wsrep_sst_method = mariabackup
# wsrep_sst_auth = "sst_user:sst_password"
# binlog_format = ROW
# default_storage_engine = InnoDB
# innodb_autoinc_lock_mode = 2
