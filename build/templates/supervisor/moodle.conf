; =============================================================================
; SUPERVISOR CONFIGURATION FOR MOODLE
; edulution-moodle - Process Management
; =============================================================================
; This file manages all processes required for the Moodle container
; Place in /etc/supervisor/conf.d/moodle.conf
; =============================================================================

; =============================================================================
; GLOBAL SUPERVISOR SETTINGS
; =============================================================================
[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
logfile_maxbytes=50MB
logfile_backups=10
loglevel=info
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor

; =============================================================================
; UNIX HTTP SERVER (for supervisorctl)
; =============================================================================
[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

; =============================================================================
; APACHE WEB SERVER
; =============================================================================
; Main web server process serving Moodle
[program:apache2]
command=/usr/sbin/apache2ctl -D FOREGROUND
autostart=true
autorestart=true
startretries=3
startsecs=5
stopwaitsecs=10
stderr_logfile=/var/log/supervisor/apache2.err.log
stdout_logfile=/var/log/supervisor/apache2.out.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=5
priority=10
user=root
environment=APACHE_RUN_USER="www-data",APACHE_RUN_GROUP="www-data",APACHE_PID_FILE="/var/run/apache2/apache2.pid",APACHE_RUN_DIR="/var/run/apache2",APACHE_LOCK_DIR="/var/lock/apache2",APACHE_LOG_DIR="/var/log/apache2"

; =============================================================================
; MOODLE CRON
; =============================================================================
; Moodle's scheduled task processor - runs every minute
[program:moodle-cron]
command=/bin/bash -c "while true; do php /var/www/html/moodle/admin/cli/cron.php 2>&1 | tee -a /var/log/moodle/cron.log; sleep 60; done"
directory=/var/www/html/moodle
autostart=true
autorestart=true
startretries=5
startsecs=10
stopwaitsecs=30
stderr_logfile=/var/log/supervisor/moodle-cron.err.log
stdout_logfile=/var/log/supervisor/moodle-cron.out.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=3
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=3
priority=30
user=www-data

; =============================================================================
; EDULUTION SYNC SERVICE
; =============================================================================
; Synchronizes users and groups from edulution API
[program:moodle-sync]
command=/opt/sync-venv/bin/python /opt/edulution-moodle-sync/sync.py
directory=/opt/edulution-moodle-sync
autostart=true
autorestart=true
startretries=5
startsecs=10
stopwaitsecs=30
stderr_logfile=/var/log/supervisor/moodle-sync.err.log
stdout_logfile=/var/log/supervisor/moodle-sync.out.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=5
priority=20
user=root
environment=PYTHONUNBUFFERED="1",PYTHONPATH="/opt/edulution-moodle-sync"

; =============================================================================
; ADMIN API (FastAPI/Uvicorn)
; =============================================================================
; REST API for administrative tasks (health checks, sync triggers, etc.)
[program:admin-api]
command=/opt/sync-venv/bin/uvicorn admin_api:app --host 0.0.0.0 --port 8080 --workers 2
directory=/opt/edulution-moodle-sync
autostart=true
autorestart=true
startretries=5
startsecs=5
stopwaitsecs=10
stderr_logfile=/var/log/supervisor/admin-api.err.log
stdout_logfile=/var/log/supervisor/admin-api.out.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=5
priority=25
user=root
environment=PYTHONUNBUFFERED="1",PYTHONPATH="/opt/edulution-moodle-sync"

; =============================================================================
; PHP-FPM (if using FPM instead of mod_php)
; =============================================================================
; Uncomment if using PHP-FPM
; [program:php-fpm]
; command=/usr/sbin/php-fpm8.1 -F
; autostart=true
; autorestart=true
; startretries=3
; startsecs=5
; stderr_logfile=/var/log/supervisor/php-fpm.err.log
; stdout_logfile=/var/log/supervisor/php-fpm.out.log
; stdout_logfile_maxbytes=10MB
; priority=5
; user=root

; =============================================================================
; HEALTH CHECK SERVICE
; =============================================================================
; Periodic health checks with auto-recovery
[program:health-monitor]
command=/bin/bash -c "while true; do /opt/scripts/health_check.sh >> /var/log/moodle/health.log 2>&1; sleep 300; done"
autostart=true
autorestart=true
startretries=3
startsecs=5
stderr_logfile=/var/log/supervisor/health-monitor.err.log
stdout_logfile=/var/log/supervisor/health-monitor.out.log
stdout_logfile_maxbytes=5MB
stdout_logfile_backups=2
priority=50
user=root

; =============================================================================
; LOG ROTATION SERVICE
; =============================================================================
; Rotates and compresses log files
[program:log-rotator]
command=/bin/bash -c "while true; do /usr/sbin/logrotate /etc/logrotate.conf; sleep 86400; done"
autostart=true
autorestart=true
startretries=3
startsecs=5
stderr_logfile=/var/log/supervisor/log-rotator.err.log
stdout_logfile=/var/log/supervisor/log-rotator.out.log
stdout_logfile_maxbytes=1MB
priority=100
user=root

; =============================================================================
; EVENT LISTENER - Process Monitor
; =============================================================================
; Monitors process events and can trigger alerts
[eventlistener:process-monitor]
command=/opt/scripts/supervisor_event_handler.py
events=PROCESS_STATE_FATAL,PROCESS_STATE_EXITED,PROCESS_STATE_STOPPED
autostart=true
autorestart=true
stderr_logfile=/var/log/supervisor/process-monitor.err.log
stdout_logfile=/var/log/supervisor/process-monitor.out.log
stdout_logfile_maxbytes=5MB
priority=999

; =============================================================================
; PROCESS GROUPS
; =============================================================================
; Group all Moodle-related processes for easier management
[group:moodle]
programs=apache2,moodle-cron,moodle-sync,admin-api,health-monitor

; =============================================================================
; USAGE NOTES
; =============================================================================
; Start all services:      supervisorctl start all
; Stop all services:       supervisorctl stop all
; Restart a service:       supervisorctl restart apache2
; Check status:            supervisorctl status
; Tail logs:               supervisorctl tail -f moodle-cron
; Reload config:           supervisorctl reread && supervisorctl update
