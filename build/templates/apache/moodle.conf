# =============================================================================
# MOODLE APACHE VIRTUALHOST CONFIGURATION
# edulution-moodle - Production Configuration
# =============================================================================

<VirtualHost *:80>
    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/html/moodle

    # Server name (will be overwritten by environment)
    ServerName ${MOODLE_WWWROOT_HOST}

    # Error and access logs
    ErrorLog ${APACHE_LOG_DIR}/moodle_error.log
    CustomLog ${APACHE_LOG_DIR}/moodle_access.log combined

    # PHP-FPM Integration via proxy
    <FilesMatch \.php$>
        SetHandler "proxy:unix:/run/php/php8.1-fpm.sock|fcgi://localhost"
    </FilesMatch>

    # Document Root Directory Settings
    <Directory /var/www/html/moodle>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted

        # Rewrite Rules for Moodle
        <IfModule mod_rewrite.c>
            RewriteEngine On
            RewriteBase /

            # Redirect to HTTPS if behind reverse proxy
            RewriteCond %{HTTP:X-Forwarded-Proto} =http
            RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

            # Moodle clean URLs (slasharguments)
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule ^(.*)$ index.php?q=$1 [L,QSA]
        </IfModule>
    </Directory>

    # Protect sensitive files
    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>

    <FilesMatch "(config\.php|version\.php|readme\.txt|README\.md|CHANGELOG\.txt)$">
        Require all denied
    </FilesMatch>

    # Deny access to config.php directly
    <Files "config.php">
        Require all denied
    </Files>

    # Protect git and other version control directories
    <DirectoryMatch "/\.(git|svn|hg)">
        Require all denied
    </DirectoryMatch>

    # Moodledata should not be accessible via web
    <Directory /var/moodledata>
        Require all denied
    </Directory>

    # Disable ETags (security best practice)
    FileETag None

    # Include security headers
    Include /etc/apache2/conf-available/security-headers.conf

    # Enable compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css
        AddOutputFilterByType DEFLATE text/javascript application/javascript application/json
        AddOutputFilterByType DEFLATE application/xml application/xhtml+xml
        AddOutputFilterByType DEFLATE image/svg+xml
    </IfModule>

    # Browser caching for static assets
    <IfModule mod_expires.c>
        ExpiresActive On

        # Images
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/gif "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType image/webp "access plus 1 year"
        ExpiresByType image/svg+xml "access plus 1 year"
        ExpiresByType image/x-icon "access plus 1 year"

        # CSS and JavaScript
        ExpiresByType text/css "access plus 1 month"
        ExpiresByType text/javascript "access plus 1 month"
        ExpiresByType application/javascript "access plus 1 month"

        # Fonts
        ExpiresByType font/ttf "access plus 1 year"
        ExpiresByType font/otf "access plus 1 year"
        ExpiresByType font/woff "access plus 1 year"
        ExpiresByType font/woff2 "access plus 1 year"
        ExpiresByType application/font-woff "access plus 1 year"
        ExpiresByType application/font-woff2 "access plus 1 year"
    </IfModule>

    # Limit request body size (256MB for file uploads)
    LimitRequestBody 268435456

    # Timeout settings
    Timeout 300
    ProxyTimeout 300

    # Keep-Alive settings
    KeepAlive On
    MaxKeepAliveRequests 100
    KeepAliveTimeout 5

</VirtualHost>

# =============================================================================
# HTTPS VirtualHost (when SSL termination is done at Apache level)
# Note: In most deployments, SSL is handled by a reverse proxy (nginx/traefik)
# =============================================================================

# <VirtualHost *:443>
#     ServerAdmin webmaster@localhost
#     DocumentRoot /var/www/html/moodle
#     ServerName ${MOODLE_WWWROOT_HOST}
#
#     SSLEngine on
#     SSLCertificateFile /etc/ssl/certs/moodle.crt
#     SSLCertificateKeyFile /etc/ssl/private/moodle.key
#     SSLCertificateChainFile /etc/ssl/certs/moodle-chain.crt
#
#     # Modern SSL configuration
#     SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
#     SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
#     SSLHonorCipherOrder off
#     SSLSessionTickets off
#
#     # Include the same directory settings as HTTP VirtualHost
# </VirtualHost>
