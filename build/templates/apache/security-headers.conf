# =============================================================================
# APACHE SECURITY HEADERS CONFIGURATION
# edulution-moodle - Security Hardening
# =============================================================================
# This file should be included in the main VirtualHost configuration
# or enabled via: a2enconf security-headers
# =============================================================================

<IfModule mod_headers.c>
    # =========================================================================
    # HTTP Strict Transport Security (HSTS)
    # =========================================================================
    # Forces browsers to use HTTPS for all future requests
    # max-age: 1 year (31536000 seconds)
    # includeSubDomains: Apply to all subdomains
    # preload: Allow inclusion in browser HSTS preload lists
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

    # =========================================================================
    # Content Type Options
    # =========================================================================
    # Prevents browsers from MIME-sniffing a response away from the declared content-type
    Header always set X-Content-Type-Options "nosniff"

    # =========================================================================
    # Frame Options
    # =========================================================================
    # Prevents clickjacking attacks by controlling whether the site can be framed
    # SAMEORIGIN allows framing by the same origin (needed for Moodle iframe features)
    Header always set X-Frame-Options "SAMEORIGIN"

    # =========================================================================
    # XSS Protection
    # =========================================================================
    # Enables the Cross-site scripting (XSS) filter in browsers
    # Note: Modern browsers have this built-in, but this header provides backwards compatibility
    Header always set X-XSS-Protection "1; mode=block"

    # =========================================================================
    # Referrer Policy
    # =========================================================================
    # Controls how much referrer information is sent with requests
    # strict-origin-when-cross-origin: Send full URL for same-origin, only origin for cross-origin
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # =========================================================================
    # Permissions Policy (formerly Feature-Policy)
    # =========================================================================
    # Controls which browser features can be used
    # Moodle may need some features like camera/microphone for BigBlueButton integration
    Header always set Permissions-Policy "geolocation=(), microphone=(self), camera=(self), payment=(), usb=()"

    # =========================================================================
    # Content-Security-Policy (CSP)
    # =========================================================================
    # Defines approved sources of content that browsers can load
    # This is a permissive policy suitable for Moodle - adjust based on your plugins
    #
    # default-src 'self'      - Default to same origin
    # script-src              - Allow inline scripts (Moodle requires this)
    # style-src               - Allow inline styles (Moodle requires this)
    # img-src                 - Allow images from self, data URIs, and HTTPS
    # font-src                - Allow fonts from self and data URIs
    # frame-ancestors 'self'  - Only allow framing by same origin
    # frame-src               - Allow iframes from self and common video providers
    # connect-src             - Allow AJAX/WebSocket connections
    # media-src               - Allow media from self and common providers
    #
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https: blob:; font-src 'self' data: https:; frame-ancestors 'self'; frame-src 'self' https://www.youtube.com https://player.vimeo.com https://*.bigbluebutton.org; connect-src 'self' https: wss:; media-src 'self' https: blob:; object-src 'none'; base-uri 'self'; form-action 'self';"

    # =========================================================================
    # Remove Server Information Headers
    # =========================================================================
    # Hide server software information for security
    Header always unset Server
    Header always unset X-Powered-By
    Header unset X-Powered-By

    # =========================================================================
    # Cross-Origin Headers
    # =========================================================================
    # Cross-Origin-Embedder-Policy: Prevents loading of cross-origin resources
    # Note: Be careful with this, it may break some Moodle plugins
    # Header always set Cross-Origin-Embedder-Policy "require-corp"

    # Cross-Origin-Opener-Policy: Isolates browsing context
    Header always set Cross-Origin-Opener-Policy "same-origin"

    # Cross-Origin-Resource-Policy: Controls resource sharing
    Header always set Cross-Origin-Resource-Policy "same-site"

    # =========================================================================
    # Cache Control for Security-Sensitive Pages
    # =========================================================================
    # Prevent caching of sensitive pages (applied to specific paths via SetEnvIf)
    <If "%{REQUEST_URI} =~ m#^/(login|admin|user|my)#">
        Header always set Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0"
        Header always set Pragma "no-cache"
        Header always set Expires "0"
    </If>
</IfModule>

# =============================================================================
# Server Signature and Tokens
# =============================================================================
# Hide Apache version information
ServerTokens Prod
ServerSignature Off

# =============================================================================
# Trace Method Disabled
# =============================================================================
# Disable HTTP TRACE method to prevent XST attacks
TraceEnable Off
