services:
  db:
    image: mariadb:10.11
    restart: unless-stopped
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    environment:
      - MARIADB_USER=${MOODLE_DATABASE_USER:-moodle}
      - MARIADB_PASSWORD=${MOODLE_DATABASE_PASSWORD:-moodle}
      - MARIADB_DATABASE=${MOODLE_DATABASE_NAME:-moodle}
      - MARIADB_ROOT_PASSWORD=${MOODLE_DATABASE_PASSWORD:-moodle}
    volumes:
      - db-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect"]
      interval: 10s
      timeout: 5s
      retries: 3

  moodle:
    build: .
    image: ghcr.io/edulution-io/edulution-moodle:latest
    restart: unless-stopped
    ports:
      - "8080:80"
    environment:
      # Moodle Core Settings
      - MOODLE_DATABASE_HOST=db
      - MOODLE_DATABASE_NAME=${MOODLE_DATABASE_NAME:-moodle}
      - MOODLE_DATABASE_USER=${MOODLE_DATABASE_USER:-moodle}
      - MOODLE_DATABASE_PASSWORD=${MOODLE_DATABASE_PASSWORD:-moodle}
      - MOODLE_WWWROOT=${MOODLE_WWWROOT:-http://localhost:8080/moodle-app}
      - MOODLE_ADMIN_USER=${MOODLE_ADMIN_USER:-admin}
      - MOODLE_ADMIN_PASSWORD=${MOODLE_ADMIN_PASSWORD:-Admin123!}
      - MOODLE_ADMIN_EMAIL=${MOODLE_ADMIN_EMAIL:-admin@example.com}
      - MOODLE_SITE_NAME=${MOODLE_SITE_NAME:-Moodle}
      - MOODLE_REVERSEPROXY=${MOODLE_REVERSEPROXY:-false}
      - MOODLE_SSLPROXY=${MOODLE_SSLPROXY:-false}
      - MOODLE_ALLOWFRAMEMBEDDING=${MOODLE_ALLOWFRAMEMBEDDING:-true}
      # Edulution Plugin - Keycloak Settings (takes precedence over admin settings)
      - EDULUTION_KEYCLOAK_URL=https://ui.kepler-freiburg.de/auth
      - EDULUTION_KEYCLOAK_REALM=edulution
      - EDULUTION_KEYCLOAK_CLIENT_ID=moodle
      # - EDULUTION_KEYCLOAK_CLIENT_SECRET=${EDULUTION_KEYCLOAK_CLIENT_SECRET:-}
      # - EDULUTION_KEYCLOAK_SYNC_ENABLED=${EDULUTION_KEYCLOAK_SYNC_ENABLED:-false}
      # - EDULUTION_VERIFY_SSL=${EDULUTION_VERIFY_SSL:-true}
      # - EDULUTION_COOKIE_AUTH_ENABLED=${EDULUTION_COOKIE_AUTH_ENABLED:-false}
    volumes:
      - moodledata:/var/moodledata
      # Plugin f√ºr Entwicklung (Moodle 5.x: plugins in public/)
      - ./local/edulution:/var/www/html/moodle/public/local/edulution
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost/login/index.php || exit 1"]
      interval: 60s
      timeout: 10s
      start_period: 120s
      retries: 3

volumes:
  db-data:
  moodledata:
